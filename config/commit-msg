#!/bin/bash

echo -e "\033[37;1mğŸª Running Git Hooks: commit-msg\033[0m"
# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šç¾©
MSG="$(cat "$1")"
readonly MSG
# çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’å®šç¾©ã€‚0: OK, 1: NG
code=0

# Prefixã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
echo -en " - Prefixãƒã‚§ãƒƒã‚¯: "
## å¿…è¦ãªPrefixã‚’å®šç¾©
readonly CORRECT_PREFIXES=("feat" "fix" "docs" "style" "refactor" "test")
## å„è¦ç´ ã«": "ã‚’è¿½åŠ 
for i in "${!CORRECT_PREFIXES[@]}"; do
  correct_prefixes[i]="${CORRECT_PREFIXES[i]}: "
done
## `grep -E`ã§é…åˆ—ã‹ã‚‰ORæ¤œç´¢ã‚’ã™ã‚‹ãŸã‚ã€åŠè§’ã‚¹ãƒšãƒ¼ã‚¹(" ")ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚’ãƒ‘ã‚¤ãƒ—("|")ã«å¤‰æ›´
prefixes="$(
  IFS="|"
  echo "${correct_prefixes[*]}"
)"
if ! echo "$MSG" | grep -Eq "${prefixes}"; then
  echo -e "\033[31;22mNG"
  echo -e "================================================================"
  echo -e "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«PrefixãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
  echo -e ""
  echo -e "Prefix"
  echo -e "  ${correct_prefixes[*]}"
  echo -e "================================================================\033[0m\n"
  code=1
else
  echo -e "\033[32;22mOK\033[0m"
fi

# issueç•ªå·ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
echo -en " - issueç•ªå·ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯: "
readonly ISSUE_NO="\#[1-9]"
if ! echo "$MSG" | grep -q "${ISSUE_NO}"; then
  echo -e "\033[31;22mNG"
  echo -e "================================================================"
  echo -e "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
  echo -e ""
  echo -e "Example: #1234"
  echo -e "================================================================\033[0m\n"
  code=1
else
  echo -e "\033[32;22mOK\033[0m"
fi

# çµ‚äº†å®£è¨€
if [ ${code} -eq 0 ]; then
  echo ""
  echo -e "\033[32;1mâœ¨ALL PASS!!\033[0m\n\n"
else
  echo ""
  echo -e "\033[31;1mGit Hooks: commit-msg: NG\033[0m\n\n"
fi

exit ${code}